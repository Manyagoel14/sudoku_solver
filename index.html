<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sudoku Game + Solver</title>

    <!-- React + Babel FIRST -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind AFTER React -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .cell {
            width: 48px;
            height: 48px;
            text-align: center;
            border: 1px solid #ccc;
            font-size: 20px;
        }

        /* Bold 3Ã—3 borders */
        .cell:nth-child(3n+1) {
            border-left: 3px solid black;
        }

        .row:nth-child(3n+1) .cell {
            border-top: 3px solid black;
        }

        .cell:nth-child(9) {
            border-right: 3px solid black;
        }

        .row:nth-child(9) .cell {
            border-bottom: 3px solid black;
        }

        .given {
            background: #e8ecff;
            font-weight: bold;
            color: #1a3bcf;
        }

        .wrong {
            background: #ffcccc !important;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-purple-600 to-indigo-700 min-h-screen flex items-center justify-center p-6">

    <div id="root" class="w-full max-w-3xl"></div>

    <script type="text/babel">

        const { useState, useEffect } = React;

        function App() {

            const empty = () => Array(9).fill().map(() => Array(9).fill(""));

            const [board, setBoard] = useState(empty());
            const [solution, setSolution] = useState(empty());
            const [given, setGiven] = useState(empty());
            const [time, setTime] = useState(0);
            const [running, setRunning] = useState(false);
            const [status, setStatus] = useState("Playing");

            // Timer
            useEffect(() => {
                let t = null;
                if (running) {
                    t = setInterval(() => setTime(t => t + 1), 1000);
                }
                return () => clearInterval(t);
            }, [running]);

            const formatTime = () =>
                `${String(Math.floor(time / 60)).padStart(2, "0")}:${String(time % 60).padStart(2, "0")}`;

            // Load puzzle
            async function loadPuzzle(level) {
                const res = await fetch(`http://localhost:5000/generate?difficulty=${level}`);
                const data = await res.json();

                setBoard(data.puzzle);
                setSolution(data.solution);
                setGiven(data.puzzle.map(row => row.map(v => v !== 0)));

                setTime(0);
                setRunning(true);
                setStatus("Playing");
            }

            // Change cell
            function handleChange(r, c, val) {
                if (given[r][c]) return;
                if (!/^[1-9]?$/.test(val)) return;

                const newBoard = structuredClone(board);
                newBoard[r][c] = val ? Number(val) : "";
                setBoard(newBoard);

                const cell = document.getElementById(`cell-${r}-${c}`);

                if (val && Number(val) !== solution[r][c]) cell.classList.add("wrong");
                else cell.classList.remove("wrong");

                checkWin(newBoard);
            }

            // Check for win
            function checkWin(grid) {
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (Number(grid[r][c]) !== solution[r][c]) return;
                    }
                }

                setRunning(false);
                setStatus("Completed");
                alert("ðŸŽ‰ You solved the Sudoku!");
            }

            function solveInstant() {
                setBoard(solution);
                setRunning(false);
                setStatus("Solved");
            }

            // Visualization
            async function visualize() {
                const res = await fetch("http://localhost:5000/solve", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ grid: board })
                });

                const data = await res.json();

                for (const s of data.steps) {
                    await new Promise(res => setTimeout(res, 25));
                    setBoard(prev => {
                        let b = structuredClone(prev);
                        b[s.row][s.col] = s.value;
                        return b;
                    });
                }
                setRunning(false);
            }

            return (
                <div className="bg-white p-6 rounded-2xl shadow-2xl">

                    <h1 className="text-4xl text-purple-700 text-center font-extrabold">
                        Sudoku Game + Solver
                    </h1>

                    <div className="text-center mt-2 text-lg font-semibold">
                        Status: {status} | Time: {formatTime()}
                    </div>

                    {/* GRID */}
                    <div className="mx-auto my-6 p-3 bg-gray-200 rounded-xl">
                        {board.map((row, r) => (
                            <div key={r} className="row flex">
                                {row.map((val, c) => (
                                    <input
                                        key={c}
                                        id={`cell-${r}-${c}`}
                                        value={val === 0 ? "" : val}
                                        className={`cell ${given[r][c] ? "given" : ""}`}
                                        onChange={e => handleChange(r, c, e.target.value)}
                                        readOnly={given[r][c]}
                                    />
                                ))}
                            </div>
                        ))}
                    </div>

                    {/* BUTTONS */}
                    <div className="flex flex-wrap justify-center gap-3">

                        <button onClick={() => loadPuzzle("easy")}
                            className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                            Easy
                        </button>

                        <button onClick={() => loadPuzzle("medium")}
                            className="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">
                            Medium
                        </button>

                        <button onClick={() => loadPuzzle("hard")}
                            className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                            Hard
                        </button>

                        <button onClick={solveInstant}
                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            Solve
                        </button>

                        <button onClick={visualize}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">
                            Visualize
                        </button>

                    </div>

                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById("root"));
    </script>

</body>

</html>
